
#+PROPERTY: header-args:jupyter-python :kernel PROMICE_dev :session PROMICE-README :exports both
#+PROPERTY: header-args:bash :exports both

* Table of contents                               :toc_3:noexport:
- [[#introduction][Introduction]]
  - [[#overview][Overview]]
- [[#level-00][Level 00]]
- [[#level-0][Level 0]]
  - [[#l0-files][L0 files]]
  - [[#level-0m][Level 0M]]
    - [[#format][Format]]
    - [[#additional-files][Additional files]]
    - [[#l0m-reader][L0M Reader]]
- [[#l0m---l1][L0M -> L1]]
  - [[#wrapper][Wrapper]]
  - [[#imports][Imports]]
  - [[#read-in-file][Read in file]]
  - [[#eng-to-phys][Eng to phys]]
  - [[#export-file-as-l1][Export file as L1]]
- [[#level-1][Level 1]]
- [[#l1---l1a][L1 -> L1A]]
  - [[#merge-files][Merge files]]
  - [[#flag-data][Flag data]]
  - [[#export-file-as-l1a][Export file as L1A]]

* Introduction

Code used to process the PROMICE AWS data from Level 0 through Level 3 (end-user product).

We use the following processing levels, described textually and graphically.

** Overview
+ L00 : Sensor data in the CR-1000 logger
+ L0: Raw data from L00 in CSV file format with suggested filenames and organized by station folder
  + =raw=, =STM= (Slim Table Memory), and =TX= (transmitted)
+ L0M: (MANUAL)
  + Standardized NEAD headers for =raw=, =STM=, and =TX=
  + Manually split so no file includes changed sensors
  + Precise file names
+ L1:
  + Engineering units (e.g. current or volts) converted to physical units (e.g. temperature or wind speed)
+ L1A:
  + Invalid / bad / suspicious data flagged
  + Files merged to one time series per station
+ L2:
  + Ancillary data from other sensors (e.g. radiometric correction requires input of tilt sensor)
+ L3:
  + Derived products (e.g. SHF and LHF)
  + Merge formats to one product here?

#+begin_src ditaa :file ./fig/levels.png :exports results

                    +----------------+
	            |{d}             |                         Legend
                    | Digital counts |                         +---------------+
     Level 00 (L00) |                |                         |input          |
		    | CR-1000 logger |                         +---------------+
	            |                |
	            +-------+--------+                         +---------------+   +=----+
	                    |				       |{io}process    +--=+ Note|
	                    v				       +---------------+   +-----+
                    +----------------+
	            |{io}            |                         +---------------+
                    |  Manual Carry  |      		       |{d}Files       |
                    |      or        |      		       +---------------+
		    |   Satellite    |
	            |                |			
	            +-------+--------+			
	                    |               +=---------------------------------+            
	                    v            +--+Arbitrary file names              |            
                    +----------------+   |  |Repeat data (more than 1 download)|            
	            |{d}             |   |  |More than 1 sensor per file       |
                    |  raw, STM, TX  +=--+  +----------------------------------+
     Level 0 (L0)   |                |      
		    | GEUS text files|	    
	            |                |	    
	            +-------+--------+	    	   						    
	                    |		         	        /----------------------------------\ 		
	                    v		                   +----+ Split files by sensor changes{io}| 		
                    +----------------+                     |    +----------------------------------+ 		
	            |{io}            |	                   |					    
                    |  Copy L0 to    |	                   |    +--------------------+		    
                    |       L0M      |                     +----+ Precise file names | 		    
	            |                |	   +---------------+    +--------------------+		    
	            +-------+--------+     |               |					    
                            |              |               |    +--------------------+		    
                            v              |               +----+ NEAD headers       |		    
		    +-------+---------+    |	    	        +--------------------+		    
		    |{d}              |    |     	          ^      ^     ^			    
                    |     Manual      |    |                      |      |     |			    
     Level 0M (L0M) |                 |<---+                      |      |   +-+----------+	    
		    | Standardization |                           |      |   |Metadata    |	    
		    |                 |                           |      |   +------------+	    
 		    +-------+---------+                           |    +-+----------------+	    
			    |	      	                          |    |Columns, units, ..|	    
                            v               	                  |    +------------------+	    
	            +-----------------+           	        +-+---------------------------------+
	            |{io}             |                         | Instrument calibration parameters |
	            |  Engineering to |   	   	        |      (recorded, not applied)      |
	            |  physical units |                         +-----------------------------------+
	            |                 |   
                    +-------+---------+   
		            |      	  
	                    v             
                    +-----------------+   
		    |{d}              |   
    Level 1 (L1)    |Measured physical|   
		    |    properties   |
		    |                 |
		    +-------+---------+	  
                            |		  
                            v		  
                    +-----------------+
                    |{io}             |
                    |   Flag bad data |
                    |   Merge files   |
                    |                 |
                    +-------+---------+
                            |           
                            v          
                   +-------------------+
                   |{d}                |
    Level 1A (L1A) |Time series per AWS|
                   |  Initial data QC  |
		   |                   |
                   +-------+-----------+
                           |
                           v
                    +-----------------+
                    |{io}             |       +=------------------------------------------+ 
                    | Cross-sensor    |------=+e.g. ice at 1 m depth via interpolation, or| 
                    |  corrections    |       |radiation adjusting for platform rotation  |
                    |                 |       +-------------------------------------------+ 
                    +-------+---------+       
                            |          
                            v          
                   +-------------------+
                   |{d}                |
     Level 2 (L2)  |  Derived internal |
                   |      values       |
	           |                   |
                   +-------+-----------+
                           |
                           v
                    +-----------------+
                    |{io}             |
                    |     Derive      |       +=-----------------------+
                    |    external     |------=+e.g. sensible heat flux,|
                    |   properties    |       |latent heat flux        |
                    |                 |       +------------------------+
                    +-------+---------+
                            |          
                            v          
                   +-------------------+
                   |{d}                |
     Level 3 (L3)  |  Derived external |
                   |      values       |
		   |                   |
                   +-------------------+


#+END_SRC
		    
#+RESULTS:
[[file:./fig/levels.png]]

* Level 00

+ Digital numbers (DN) in the CR1000 logger.

* Level 0

Level 00 is converted to Level 0 in the CR1000 logger during download, or after the DNs are broadcast to the satellite and processed by the MCIT_script (see https://github.com/GEUS-PROMICE/awsrx).

#+begin_src plantuml :file ./fig/L00_to_L0.png :exports results
@startuml

' plantuml activity diagram (beta)

component Sensor_1
component Sensor_n

frame CR1000_Logger {
  database DB_logger [
  <b>Database</b>
  10 minute sampling
  ----
  var0, var1, ..., varn
] 
}

note right
  Level 00 (L00)
end note

Sensor_1 --> CR1000_Logger
Sensor_n --> CR1000_Logger

node GEUS_(Level_0) {
  file Raw [
  <b>raw</b>
  10 min sampling
  ]

  file SlimTableMem [
  <b>SlimTableMem</b>
  Hourly average from
  10 min sampling
  ]

  file TX [
  <b>TX</b>
  V3:
    DOY 100 to 300: hourly average
    DOY 300 to 100: daily average
  V4:
    hourly average all days
  ]
}

' DB -> hand carry -> raw
actor Scientist
DB_logger --> Scientist : Field\ndownload
Scientist --> Raw : Hand\ncarry
Scientist --> SlimTableMem : Hand\ncarry

' DB -> satellite -> Transmitted
cloud Satellite
file Email
queue MCIT_script

DB_logger -[dashed]-> Satellite : Data subsampled and\npossible transmission loss
Satellite -[dashed]-> Email
Email --> MCIT_script : L00
MCIT_script --> TX

@enduml
#+end_src

#+RESULTS:
[[file:./fig/L00_to_L0.png]]

** L0 files

+ =raw= : All 10-minute data stored on the CF-card (external module on CR1000)
+ =SlimTableMem= : Hourly averaged 10-min data stored in the internal logger memory
+ =transmitted= : Transmitted via satellite. Only a subset of data is transmitted, and only hourly or daily average depending on station and day of year.

Level 0 files are stored in the =data/L0/<S>/= folder, where =<S>= is the station name. File names should encode the station, end-of-year of download, a version number if there are multiple files for a given year, and the format. However, no code reads thees files, so there is no strict file naming convention. Still, best practices would use the following conventions:  

=data/<L>/<S>/<S>-<Y>[.<n>]-<F>.txt=

Where 

+ =<L>= is the processing level
  + =<L>= must be one of the following: [L0, L0M, L1, L1A, L2, L3]
+ =<S>= is a station ID
  + =<S>= must be one of the following strings: [CEN, EGP, KAN_B, KAN_L, KAN_M, KAN_U, KPC_L, KPC_U, MIT, NUK_K, NUK_L, NUK_N, NUK_U, QAS_A, QAS_L, QAS_M, QAS_U, SCO_L, SCO_U, TAS_A, TAS_L, TAS_U, THU_L, THU_U, UPE_L, UPE_U]
+ =<Y>= is a four-digit year with a value greater than =2008=
  + =<Y>= should represent the year at the last timestamp in the file
  + Optionally, =.<n>= is a version number if multiple files from the same year are present
+ =<F>= is the format, one of =raw=, =TX=, or =STM=


** Level 0M

Level 0M (L0M) is L0 with the following *manual* changes:

+ Files that will continue in the processing pipeline are copied from =L0/<S>/= to =L0M/<S>/= folders.
+ Strict naming format must be followed: =data/L0M/<S>/<S>-<Y>[.<n>]-<F>.txt= (see L0 naming suggestion above, now a requirement)
+ Headers, if present, are standardized to NEAD 1.0 format
  + NEAD header templates are provided, or should be copied from existing files and updated for the new data/sensors/loggers/etc.
  + NEAD headers should include instrument calibration parameters, serial numbers, etc.
  + Existing headers, if they exist, are removed. Any information that should be retained is incorporated into the NEAD header. The L0 data will always retain the original unmodified header if it is needed.
  + NEAD format specification: https://github.com/GEUS-PROMICE/NEAD/
+ Split files if necessary
  + Files should be split so that each file only contains one of each sensor. That is if a station visit swapped sensor X with Y, then two files should exist, one with X (with metadata such as serial number, calibration paramater, etc. for X), and one with Y (with associated metadata).

All changes should be documented in the [[./data/L0M/README.org]] file.
    
*** Format

We use the [[https://github.com/mankoff/NEAD/][NEAD 1.0]] file format with PROMICE-specific headers. A detailed description of the format is at https://github.com/GEUS-PROMICE/NEAD and a Python reader is at https://github.com/GEUS-PROMICE/pyNEAD.

*** Additional files

Any files that do not conform to the above name format requirement will be ignored. However, for cleanliness, additional files should be placed in sub-folders of =L0/<S>=. If any additional files are created in order to manually adjust problematic data or for any other purpose, an entry should be created in the top level =data/README.org= linking to the original file, the new file, describing what was done and why, and perhaps including a diff.

*** L0M Reader

#+BEGIN_SRC jupyter-python :exports both
import nead
ds = nead.read("./data/L0M/EGP/EGP-2016-raw.txt", index_col=0)
print(ds)
#+END_SRC

#+RESULTS:
#+begin_example
<xarray.Dataset>
Dimensions:      (time: 10847)
Coordinates:
  ,* time         (time) datetime64[ns] 2016-05-01T14:30:00 ... 2016-07-19T17:...
Data variables:
    rec          (time) float64 51.0 52.0 53.0 ... 1.09e+04 1.09e+04 1.09e+04
    min_y        (time) float64 1.765e+05 1.766e+05 ... 2.905e+05 2.905e+05
    p            (time) float64 724.4 724.1 724.4 724.4 ... 730.8 731.2 730.7
    t            (time) float64 -20.1 -19.79 -19.31 ... -6.904 -6.904 -6.861
    t_hygroclip  (time) float64 -19.56 -19.11 -18.92 ... -6.866 -6.86 -6.799
    rh           (time) float64 54.1 51.7 50.23 49.51 ... 80.28 80.93 81.81
    wspd         (time) float64 1.062 0.918 0.636 0.486 ... 2.793 2.951 3.069
    wdir         (time) float64 265.1 259.2 216.8 208.4 ... 217.7 216.6 225.4
    wd_std       (time) float64 0.0 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0 0.0
    dswr         (time) float64 681.7 732.4 688.3 689.6 ... 724.7 711.4 698.8
    uswr         (time) float64 518.6 559.3 531.8 534.4 ... 559.2 549.6 524.1
    dlwr         (time) float64 -81.57 -102.0 -101.3 ... -135.8 -135.6 -132.4
    ulwr         (time) float64 -23.97 -28.65 -33.92 ... -32.33 -32.52 -28.84
    t_rad        (time) float64 -12.78 -11.42 -9.929 ... -1.114 -1.03 -1.135
    z_boom       (time) float64 2.685 2.683 2.683 2.68 ... 2.583 2.584 2.58
    z_boom_q     (time) float64 190.0 192.0 189.0 187.0 ... 192.0 182.0 168.0
    z_stake      (time) float64 nan nan nan nan nan nan ... nan nan nan nan nan
    z_stake_q    (time) float64 0.0 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0 0.0
    z_ice        (time) float64 nan nan nan nan nan nan ... nan nan nan nan nan
    t_i_1        (time) float64 nan -109.0 -109.0 ... -8.478 -8.458 -8.448
    t_i_2        (time) float64 nan nan -109.0 -109.0 ... -9.67 -9.67 -9.67
    t_i_3        (time) float64 nan -109.0 -109.0 ... -8.879 -8.859 -8.849
    t_i_4        (time) float64 nan -109.0 -109.0 ... -10.74 -10.73 -10.74
    t_i_5        (time) float64 nan -109.0 -109.0 ... -12.67 -12.67 -12.67
    t_i_6        (time) float64 nan -109.0 nan -109.0 ... -14.9 -14.9 -14.9
    t_i_7        (time) float64 nan -109.0 -109.0 nan ... -17.16 -17.16 -17.16
    t_i_10       (time) float64 nan nan -109.0 nan ... -20.75 -20.76 -20.76
    tilt_x       (time) float64 3.527 3.492 3.516 3.489 ... 0.109 0.095 0.174
    tilt_y       (time) float64 -0.945 -0.938 -0.924 ... -0.828 -0.849 -0.859
    gps_time     (time) object nan nan nan ... 'GT170007.00' 'GT170007.00'
    gps_lat      (time) object nan nan nan ... 'NH7537.47563' 'NH7537.47563'
    gps_lon      (time) object nan nan nan ... 'WH03558.49655' 'WH03558.49655'
    gps_alt      (time) float64 nan nan nan ... 2.663e+03 2.663e+03 2.663e+03
    gps_giodal   (time) float64 nan nan nan nan nan ... 41.6 41.6 41.6 41.6 41.6
    gps_geounit  (time) object nan nan nan nan nan nan ... 'M' 'M' 'M' 'M' 'M'
    gps_q        (time) float64 nan nan nan nan nan nan ... 1.0 1.0 1.0 1.0 1.0
    gps_numsat   (time) float64 nan nan nan nan nan ... 11.0 12.0 12.0 12.0 12.0
    gps_hdop     (time) float64 nan nan nan nan nan ... 0.71 0.73 0.73 0.73 0.73
    t_logger     (time) float64 -12.6 -12.08 -11.65 ... -1.801 -1.735 -1.5
    fan_dc       (time) float64 137.5 141.3 142.3 141.8 ... 123.5 123.9 124.1
    batt_v_ss    (time) float64 15.52 15.81 15.79 15.81 ... 14.47 14.47 14.47
    batt_v       (time) float64 15.23 15.56 15.53 15.63 ... 14.4 14.41 14.41
Attributes:
    station_id:          EGP
    field_delimiter:     ,
    nodata:              -999
    srid:                EPSG:4326
    geometry:            POINT(-35.9748, 75.6247)
    timezone:            0
    PROMICE_format:      raw
    hygroclip_t_offset:  0
    dswr_eng_coef:       12.71
    uswr_eng_coef:       12.71
    dlwr_eng_coef:       12.71
    ulwr_eng_coef:       12.71
    pt_z_coef:           0
    pt_z_p_coef:         0
    pt_z_factor:         0
    pt_antifreeze:       0
    boom_azimuth:        0
#+end_example



* L0M -> L1
:PROPERTIES:
:header-args:jupyter-python+: :session L0_to_L1 :noweb-ref L0_to_L1 :noweb yes
:END:

Run one:
#+BEGIN_SRC jupyter-python :noweb-ref
infile = "./data/L0M/EGP/EGP-2016-raw.txt"
<<L0_to_L1>>
#+END_SRC

Run all:

#+BEGIN_SRC bash
# conda activate PROMICE_dev
for f in $(ls ./data/L0M/EGP/EGP-201*raw*); do
  echo ${f}
  ./L0_to_L1.py ${f}
done

./L0_to_L1.py data/L0M/EGP/EGP-2017-STM.txt 
./L0_to_L1.py data/L0M/EGP/EGP-2019-TX.txt
#+END_SRC


** Wrapper

#+BEGIN_SRC jupyter-python :tangle L0_to_L1.py :noweb-ref :tangle-mode (identity #o744)
#!/usr/bin/env python

def L0_to_L1(infile=None):
    <<L0_to_L1>>


if __name__ == "__main__":
    import sys
    L0_to_L1(sys.argv[1])
    # print("here")
    # print(sys.argv)
#+END_SRC


** Imports

#+BEGIN_SRC jupyter-python
import re
import shapely
from shapely import geometry
import nead
import os
import sys
import numpy as np
#+END_SRC

#+RESULTS:

** Read in file

+ GitHub link: [[./IDL/AWSdataprocessing_v3.pro#L51]] through [[./IDL/AWSdataprocessing_v3.pro#L123]]
+ Org link: [[./IDL/AWSdataprocessing_v3.pro::51]] through [[./IDL/AWSdataprocessing_v3.pro::123]]
+ [X] Reads in the file
+ [X] Check that required metadata was included in the NEAD header

#+BEGIN_SRC jupyter-python
ds = nead.read(infile, index_col=0)

assert("geometry" in ds.attrs.keys())
assert(ds.attrs['geometry'][0:5] == "POINT")
assert("srid" in ds.attrs.keys())
assert(ds.attrs['srid'] == "EPSG:4326")
assert("timezone" in ds.attrs.keys())
assert("pt_antifreeze" in ds.attrs.keys())
#+END_SRC

#+RESULTS:

** Eng to phys

+ GitHub link: [[./IDL/AWSdataprocessing_v3.pro#L116]] through [[./IDL/AWSdataprocessing_v3.pro#L408]] 
+ Org link: [[./IDL/AWSdataprocessing_v3.pro::116]] through [[./IDL/AWSdataprocessing_v3.pro::408]] 
  + [-] Calculates derived date products (day of century, etc.)
  + [-] Adjusts start times
    + [X] ~if slimtablemem eq 'yes' then begin ; change time stamp to start of the hour instead of end~
    + [ ] ~if transmitted eq 'yes' then begin ; change transmission time to start of the hour/day instead of end~
      + [ ] ~if line[col_season-1] eq '!W' then begin ; daily transmissions~
      + [ ] ~if line[col_season-1] eq '!S' then begin ; hourly transmissions~
      + [ ] Makes guesses if season identifier not transmitted
  + [X] Adjusts UTC offset
  + [X] Remove HygroClip temperature offset
  + [X] Reads and adjusts SRin ~SRin = [SRin,float(line[col_SRin-1])*10/C_SRin] ; Calculating radiation (10^-5 V -> W/m2)~
  + [X] SRout
  + [X] LRin: ~LRin = [LRin,float(line[col_LRin-1])*10/C_LRin + 5.67e-8*(float(line[col_Trad-1])+T_0)^4]~
  + [X] LRout
  + [X] Haws: ~Haws = [Haws,float(line[col_Haws-1])*((float(line[col_T-1])+T_0)/T_0)^0.5]~
  + [X] Hstk: ~Hstk = [Hstk,float(line[col_Hstk-1])*((float(line[col_T-1])+T_0)/T_0)^0.5]~
  + [X] Hpt: ~Hpt = [Hpt,float(line[col_Hpt-1])*C_Hpt*F_Hpt*998./rho_af]~
  + [X] Derives Hpt_corrected
  + [X] Decodes GPS - some stations only record minutes not degrees


#+BEGIN_SRC jupyter-python

T_0 = 273.15

# Calculate pressure transducer fluid density
if ds.attrs['pt_antifreeze'] == 50:
    rho_af = 1092
elif ds.attrs['pt_antifreeze'] == 100:
    rho_af = 1145
else:
    rho_af = np.nan
    if np.any(~np.isnan(ds['z_ice'].values)):
        print("Antifreeze mix only supported at 50 % or 100%")
        assert(False)
    

if 'gps_geounit' in list(ds.variables): ds = ds.drop_vars('gps_geounit')        
        
## adjust times based on file format.
# raw: No adjust (timestamp is at start of period)
# STM: Adjust timestamp from end of period to start of period
# TX: Adjust timestamp start of period (hour/day) also depending on season
# if ds.attrs['PROMICE_format'] == 'STM': ds['time'] = (('time'), ds['time'].to_dataframe().shift(periods=1))
# if ds.attrs['PROMICE_format'] == 'TX': ds['time'] = (('time'), ds['time'].to_dataframe().shift(periods=1))
if ds.attrs['timezone'] != 0: ds['time'] = (('time'), ds['time'].to_dataframe().shift(periods=ds.attrs['timezone'], freq='H'))

# Remove HygroClip temperature offset
ds['t_hygroclip'] = ds['t_hygroclip'] - ds.attrs['hygroclip_t_offset']

# convert radiation from engineering to physical units
ds['dswr'] = (ds['dswr'] * 10) / ds.attrs['dswr_eng_coef']
ds['uswr'] = (ds['uswr'] * 10) / ds.attrs['dswr_eng_coef']
ds['dlwr'] = ((ds['dlwr'] * 10) / ds.attrs['dlwr_eng_coef']) + 5.67E-8*(ds['t_rad'] + T_0)**4
ds['ulwr'] = ((ds['ulwr'] * 10) / ds.attrs['dlwr_eng_coef']) + 5.67E-8*(ds['t_rad'] + T_0)**4

# Adjust sonic ranger readings for sensitivity to air temperature
ds['z_boom'] = ds['z_boom'] * ((ds['t'] + T_0)/T_0)**0.5 
ds['z_stake'] = ds['z_stake'] * ((ds['t'] + T_0)/T_0)**0.5
# Adjust pressure transducer due to fluid properties
ds['z_ice'] = ds['z_ice'] * ds.attrs['pt_z_coef'] * ds.attrs['pt_z_factor'] * 998.0 / rho_af

# Calculate pressure transducer depth
ds['z_ice_corr'] = ds['z_ice'] * np.nan # new 'z_ice_corr' copied from 'z_ice'
ds['z_ice_corr'].attrs['long_name'] = ds['z_ice'].long_name + " corrected"
ds['z_ice_corr'] = ds['z_ice'] * ds.attrs['pt_z_coef'] * ds.attrs['pt_z_factor'] * 998.0 / rho_af \
    + 100 * (ds.attrs['pt_z_p_coef'] - ds['p']) / (rho_af * 9.81)


# Decode GPS
if ds['gps_lat'].dtype.kind == 'O': # not a float. Probably has "NH"
    assert('NH' in ds['gps_lat'].dropna(dim='time').values[0])
    # for i,v in enumerate(ds['gps_lat'].values): ds['gps_lat'][i] = v[2:] if isinstance(v, str) else np.nan
    # for i,v in enumerate(ds['gps_lon'].values): ds['gps_lon'][i] = v[2:] if isinstance(v, str) else np.nan
    # for i,v in enumerate(ds['gps_time'].values): ds['gps_time'][i] = v[2:] if isinstance(v, str) else np.nan
    for v in ['gps_lat','gps_lon','gps_time']:
        a = ds[v].attrs # store
        ds[v][:] = np.array([_[2:] if isinstance(_, str) else np.nan for _ in ds[v].values]).astype(np.float)
        ds[v] = ds[v].astype(np.float)
        for k in a.keys(): ds[v].attrs[k] = a[k] # restore

if np.any((ds['gps_lat'] <= 90) & (ds['gps_lat'] > 0)):  # Some stations only recorded minutes, not degrees
    xyz = np.array(re.findall("[-+]?[\d]*[.][\d]+", ds.attrs['geometry'])).astype(np.float)
    x=xyz[0]; y=xyz[1]; z=xyz[2] if len(xyz) == 3 else 0
    p = shapely.geometry.Point(x,y,z)
    ds['gps_lat'] = ds['gps_lat'] + 100*p.y
if np.any((ds['gps_lon'] <= 90) & (ds['gps_lon'] > 0)):
    ds['gps_lon'] = ds['gps_lon'] + 100*p.x

# ds['gps_lat'] = np.floor(ds['gps_lat'] / 100) + (ds['gps_lat'] / 100 - np.floor(ds['gps_lat'] / 100)) * 100 / 60
# ds['gps_lon'] = np.floor(ds['gps_lon'] / 100) + (ds['gps_lon'] / 100 - np.floor(ds['gps_lon'] / 100)) * 100 / 60
for v in ['gps_lat','gps_lon']:
    a = ds[v].attrs # store
    ds[v] = np.floor(ds[v] / 100) + (ds[v] / 100 - np.floor(ds[v] / 100)) * 100 / 60
    for k in a.keys(): ds[v].attrs[k] = a[k] # restore
    

# tilt-o-meter voltage to degrees
abst = np.abs(ds['tilt_x'])
ds['tilt_x'] = ds['tilt_x'] / 10
ds['tilt_x'] = ds['tilt_x'] / (abst * (-0.49*abst**4 + 3.6*abst**3 - 10.4*abst**2 + 21.1*abst))
abst = np.abs(ds['tilt_y'])
ds['tilt_y'] = ds['tilt_y'] / 10
ds['tilt_y'] = ds['tilt_y'] / (abst * (-0.49*abst**4 + 3.6*abst**3 - 10.4*abst**2 + 21.1*abst))
#+END_SRC

#+RESULTS:

** Export file as L1

+ Check with ~cfchecks ./data/L1/EGP/EGP-2016-raw.nc~

#+BEGIN_SRC jupyter-python
outpath = os.path.split(infile)[0].split("/")
outpath[-2] = 'L1'
outpath = '/'.join(outpath)
outfile = os.path.splitext(os.path.basename(infile))[0]

outpathfile = outpath + '/' + outfile + ".nc"
if os.path.exists(outpathfile): os.remove(outpathfile)
ds.to_netcdf(outpathfile, mode='w', format='NETCDF4', compute=True)
#+END_SRC

#+RESULTS:



* Level 1
:PROPERTIES:
:header-args:bash+: :exports both
:END:

File list:

#+BEGIN_SRC bash :exports both :results verbatim
find ./data/L1
#+END_SRC

#+RESULTS:
: ./data/L1
: ./data/L1/EGP
: ./data/L1/EGP/EGP-2016-raw.nc

NetCDF format

#+BEGIN_SRC bash :results verbatim :exports both
ncdump -ch ./data/L1/EGP/EGP-2016-raw.nc | head -n35
#+END_SRC

#+RESULTS:
#+begin_example
netcdf EGP-2016-raw {
dimensions:
	time = 10847 ;
variables:
	double rec(time) ;
		rec:_FillValue = NaN ;
		rec:standard_name = "record" ;
		rec:long_name = "Record" ;
		rec:units = "" ;
		rec:scale_factor = 1. ;
		rec:add_offset = 0. ;
	double min_y(time) ;
		min_y:_FillValue = NaN ;
		min_y:standard_name = "minutes" ;
		min_y:long_name = "Minutes in year" ;
		min_y:units = "min" ;
		min_y:scale_factor = 1. ;
		min_y:add_offset = 0. ;
	double p(time) ;
		p:_FillValue = NaN ;
		p:standard_name = "air_pressure" ;
		p:long_name = "Air pressure" ;
		p:units = "hPa" ;
		p:scale_factor = 0.01 ;
		p:add_offset = 0. ;
	double t(time) ;
		t:_FillValue = NaN ;
		t:standard_name = "air_temperature_at_boom" ;
		t:long_name = "Air temperature" ;
		t:units = "C" ;
		t:scale_factor = 1. ;
		t:add_offset = 273.15 ;
	double t_hygroclip(time) ;
		t_hygroclip:_FillValue = NaN ;
		t_hygroclip:standard_name = "air_temperature_at_hygroclip" ;
#+end_example


* L1 -> L1A
:PROPERTIES:
:header-args:jupyter-python+: :session L1_to_L1A
:END:

Imports:

#+BEGIN_SRC jupyter-python
import pandas as pd
import xarray as xr
import os
#+END_SRC

#+RESULTS:

** Merge files
#+BEGIN_SRC jupyter-python
infile = "./data/L1/EGP/*raw.nc"
ds = xr.open_mfdataset(infile, combine='by_coords', mask_and_scale=False).load()
print(ds)
#+END_SRC

#+RESULTS:
#+begin_example
<xarray.Dataset>
Dimensions:      (time: 10847)
Coordinates:
  ,* time         (time) datetime64[ns] 2016-05-01T14:30:00 ... 2016-07-19T17:...
Data variables:
    rec          (time) float64 51.0 52.0 53.0 ... 1.09e+04 1.09e+04 1.09e+04
    min_y        (time) float64 1.765e+05 1.766e+05 ... 2.905e+05 2.905e+05
    p            (time) float64 724.4 724.1 724.4 724.4 ... 730.8 731.2 730.7
    t            (time) float64 -20.1 -19.79 -19.31 ... -6.904 -6.904 -6.861
    t_hygroclip  (time) float64 -19.56 -19.11 -18.92 ... -6.866 -6.86 -6.799
    rh           (time) float64 54.1 51.7 50.23 49.51 ... 80.28 80.93 81.81
    wspd         (time) float64 1.062 0.918 0.636 0.486 ... 2.793 2.951 3.069
    wdir         (time) float64 265.1 259.2 216.8 208.4 ... 217.7 216.6 225.4
    wd_std       (time) float64 0.0 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0 0.0
    dswr         (time) float64 536.4 576.2 541.6 542.6 ... 570.1 559.7 549.8
    uswr         (time) float64 408.0 440.0 418.4 420.5 ... 440.0 432.4 412.4
    dlwr         (time) float64 196.4 185.8 192.5 182.1 ... 203.7 204.2 206.3
    ulwr         (time) float64 241.7 243.5 245.5 245.0 ... 285.1 285.3 287.7
    t_rad        (time) float64 -12.78 -11.42 -9.929 ... -1.114 -1.03 -1.135
    z_boom       (time) float64 2.584 2.584 2.586 2.587 ... 2.55 2.551 2.547
    z_boom_q     (time) float64 190.0 192.0 189.0 187.0 ... 192.0 182.0 168.0
    z_stake      (time) float64 nan nan nan nan nan nan ... nan nan nan nan nan
    z_stake_q    (time) float64 0.0 0.0 0.0 0.0 0.0 0.0 ... 0.0 0.0 0.0 0.0 0.0
    z_ice        (time) float64 nan nan nan nan nan nan ... nan nan nan nan nan
    t_i_1        (time) float64 nan -109.0 -109.0 ... -8.478 -8.458 -8.448
    t_i_2        (time) float64 nan nan -109.0 -109.0 ... -9.67 -9.67 -9.67
    t_i_3        (time) float64 nan -109.0 -109.0 ... -8.879 -8.859 -8.849
    t_i_4        (time) float64 nan -109.0 -109.0 ... -10.74 -10.73 -10.74
    t_i_5        (time) float64 nan -109.0 -109.0 ... -12.67 -12.67 -12.67
    t_i_6        (time) float64 nan -109.0 nan -109.0 ... -14.9 -14.9 -14.9
    t_i_7        (time) float64 nan -109.0 -109.0 nan ... -17.16 -17.16 -17.16
    t_i_10       (time) float64 nan nan -109.0 nan ... -20.75 -20.76 -20.76
    tilt_x       (time) float64 0.00368 0.003663 0.003675 ... 0.05226 0.02963
    tilt_y       (time) float64 -0.007519 -0.007557 ... -0.008087 -0.008022
    gps_time     (time) float64 nan nan nan nan ... 1.7e+05 1.7e+05 1.7e+05
    gps_lat      (time) float64 nan nan nan nan nan ... 75.62 75.62 75.62 75.62
    gps_lon      (time) float64 nan nan nan nan nan ... 35.97 35.97 35.97 35.97
    gps_alt      (time) float64 nan nan nan ... 2.663e+03 2.663e+03 2.663e+03
    gps_giodal   (time) float64 nan nan nan nan nan ... 41.6 41.6 41.6 41.6 41.6
    gps_q        (time) float64 nan nan nan nan nan nan ... 1.0 1.0 1.0 1.0 1.0
    gps_numsat   (time) float64 nan nan nan nan nan ... 11.0 12.0 12.0 12.0 12.0
    gps_hdop     (time) float64 nan nan nan nan nan ... 0.71 0.73 0.73 0.73 0.73
    t_logger     (time) float64 -12.6 -12.08 -11.65 ... -1.801 -1.735 -1.5
    fan_dc       (time) float64 137.5 141.3 142.3 141.8 ... 123.5 123.9 124.1
    batt_v_ss    (time) float64 15.52 15.81 15.79 15.81 ... 14.47 14.47 14.47
    batt_v       (time) float64 15.23 15.56 15.53 15.63 ... 14.4 14.41 14.41
    z_ice_corr   (time) float64 nan nan nan nan nan nan ... nan nan nan nan nan
Attributes:
    station_id:          EGP
    field_delimiter:     ,
    nodata:              -999
    srid:                EPSG:4326
    geometry:            POINT(-35.9748, 75.6247)
    timezone:            0
    PROMICE_format:      raw
    hygroclip_t_offset:  0
    dswr_eng_coef:       12.71
    uswr_eng_coef:       12.71
    dlwr_eng_coef:       12.71
    ulwr_eng_coef:       12.71
    pt_z_coef:           0
    pt_z_p_coef:         0
    pt_z_factor:         0
    pt_antifreeze:       0
    boom_azimuth:        0
#+end_example

** Flag data

#+BEGIN_SRC bash :exports results
cat flags.csv
#+END_SRC

#+RESULTS:
| property    | low limit | high limit | other invalid | comment                                  |
| tilt_x      |       -40 |         40 |               | [[file:./IDL/AWSdataprocessing_v3.pro#L390]] |
| tilt_y      |       -40 |         40 |               |                                          |
| # tilt_x    |       -30 |         30 |               | [[file:./IDL/AWSdataprocessing_v3.pro#L675]] |
| # tilt_y    |       -30 |         30 |               |                                          |
| p           |       650 |       1100 |               |                                          |
| t           |       -80 |         30 |               | t > 30 is possible...                    |
| t_hygroclip |       -80 |         30 |             0 |                                          |
| # rh_cor    |           |        100 |               |                                          |
| wspd        |         0 |        100 |               |                                          |
| wdir        |         0 |        360 |               |                                          |
| dswr        |       -10 |       1500 |               |                                          |
| uswr        |       -10 |       1000 |               |                                          |
| dlwr        |        50 |        500 |               |                                          |
| ulwr        |        50 |        500 |               |                                          |
| t_rad       |      -180 |         50 |               |                                          |
| z_boom      |       0.3 |          3 |               |                                          |
| z_boom_q    |         0 |            |               |                                          |
| z_stake     |       0.3 |          8 |               |                                          |
| z_ice       |         0 |         30 |               |                                          |
| t_i_1       |       -80 |         30 |               |                                          |
| t_i_2       |       -80 |         30 |               |                                          |
| t_i_3       |       -80 |         30 |               |                                          |
| t_i_4       |       -80 |         30 |               |                                          |
| t_i_5       |       -80 |         30 |               |                                          |
| t_i_6       |       -80 |         30 |               |                                          |
| t_i_7       |       -80 |         30 |               |                                          |
| t_i_10      |       -30 |         30 |               | NOTE difference                          |
| gps_time    |         0 |     240000 |               |                                          |
| gps_lat     |        60 |         83 |               |                                          |
| gps_lon     |        20 |         70 |               |                                          |
| gps_alt     |         0 |       3000 |               |                                          |
| gps_hdop    |         0 |            |               |                                          |
| t_logger    |       -80 |         30 |               |                                          |
| fan_dc      |      -200 |        200 |               |                                          |
| batt_v      |         0 |         30 |               |                                          |

#+BEGIN_SRC jupyter-python
df = pd.read_csv("flags.csv", index_col=0, comment="#")

for var in df.index:
    ds[var] = ds[var].where(ds[var] < df.loc[var, 'low limit'])
    ds[var] = ds[var].where(ds[var] > df.loc[var, 'high limit'])
#+END_SRC

#+RESULTS:


** Export file as L1A

+ Check with ~cfchecks ./data/L1A/EGP/EGP-2016-raw.nc~

#+BEGIN_SRC jupyter-python
outpath = os.path.split(infile)[0].split("/")
outpath[-2] = 'L1A'
outfile = outpath[-1] + '-' + os.path.basename(infile).split('*')[1]
outpath = '/'.join(outpath)

outpathfile = outpath + '/' + outfile
if os.path.exists(outpathfile): os.remove(outpathfile)
ds.to_netcdf(outpathfile, mode='w', format='NETCDF4', compute=True)
#+END_SRC

#+RESULTS:



